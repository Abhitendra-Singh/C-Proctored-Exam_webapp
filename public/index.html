<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C Programming Proctored Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .view { display: none; }
        #warning-modal { transition: opacity 0.3s ease; }
        input[type="radio"]:checked + label {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
        }
        .no-select {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
        
        <!-- Loading View -->
        <div id="loading-view" class="view flex flex-col items-center">
            <div class="loader"></div>
            <p class="mt-4 text-gray-600">Initializing...</p>
        </div>

        <!-- Login View -->
        <div id="login-view" class="view w-full max-w-md">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-bold text-center text-gray-700 mb-6">Login</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-600 mb-2">Email</label>
                        <input type="email" id="login-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-600 mb-2">Password</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition duration-300 flex items-center justify-center">Login</button>
                </form>
                <p class="text-center text-gray-600 mt-4">
                    Don't have an account? <a href="#" id="show-signup" class="text-blue-500 hover:underline">Sign up</a>
                </p>
            </div>
        </div>

        <!-- Signup View -->
        <div id="signup-view" class="view w-full max-w-md">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-bold text-center text-gray-700 mb-6">Create Account</h2>
                <form id="signup-form">
                    <div class="mb-4">
                        <label for="signup-name" class="block text-gray-600 mb-2">Full Name</label>
                        <input type="text" id="signup-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="signup-email" class="block text-gray-600 mb-2">Email</label>
                        <input type="email" id="signup-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="signup-password" class="block text-gray-600 mb-2">Password</label>
                        <input type="password" id="signup-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition duration-300 flex items-center justify-center">Sign Up</button>
                </form>
                <p class="text-center text-gray-600 mt-4">
                    Already have an account? <a href="#" id="show-login" class="text-blue-500 hover:underline">Login</a>
                </p>
            </div>
        </div>

        <!-- Instructions View -->
        <div id="instructions-view" class="view w-full max-w-3xl">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Test Instructions</h2>
                    <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300">Logout</button>
                </div>
                <p class="mb-4 text-lg">Welcome, <span id="user-name" class="font-semibold"></span>!</p>
                
                <div id="past-attempts-container" class="mb-6">
                    <h3 class="text-xl font-semibold mb-2">Your Previous Attempts:</h3>
                    <div id="past-attempts-list" class="max-h-48 overflow-y-auto bg-gray-50 p-3 rounded-md border">
                        <!-- Past attempts will be listed here -->
                        <p class="text-gray-500">You have no previous attempts.</p>
                    </div>
                </div>

                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
                    <p class="font-bold">Important Rules</p>
                    <p>Please read the following instructions carefully before starting the test.</p>
                </div>
                <ul class="list-disc list-inside space-y-3 text-gray-700">
                    <li>This test contains <strong>10 multiple-choice questions</strong> on C programming.</li>
                    <li>You will have <strong>5 minutes</strong> to complete the test.</li>
                    <li>The test will automatically start in <strong>full-screen mode</strong>.</li>
                    <li class="font-semibold text-red-600">Do not exit full-screen mode, switch tabs, or minimize the browser. Doing so will be logged and the test will auto-submit.</li>
                </ul>
                <div class="text-center mt-8">
                    <button id="start-test-btn" class="bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 transition duration-300">Start Test</button>
                </div>
            </div>
        </div>
        
        <!-- Test View -->
        <div id="test-view" class="view w-full max-w-4xl no-select">
            <div class="bg-white p-8 rounded-lg shadow-lg relative">
                <div class="flex justify-between items-center border-b pb-4 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">C Programming Test</h2>
                    <div class="text-xl font-bold bg-red-500 text-white px-4 py-2 rounded-lg">
                        Time Left: <span id="timer">05:00</span>
                    </div>
                </div>
                <div id="question-container">
                    <p id="question-text" class="text-xl mb-6 font-medium"></p>
                    <div id="options-container" class="space-y-4"></div>
                </div>
                <div class="flex justify-between items-center mt-8">
                    <p class="text-gray-600 font-medium">Question <span id="question-number">1</span> of 10</p>
                    <button id="next-question-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">Next</button>
                    <button id="submit-test-btn" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 hidden">Submit Test</button>
                </div>
            </div>
        </div>

        <!-- Result View -->
        <div id="result-view" class="view w-full max-w-lg">
            <div class="bg-white p-8 rounded-lg shadow-lg text-center">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Test Completed!</h2>
                <p class="text-lg text-gray-600 mb-6">Here is your result:</p>
                <div class="bg-blue-100 border-2 border-blue-300 rounded-full w-48 h-48 mx-auto flex flex-col items-center justify-center mb-6">
                    <p class="text-5xl font-bold text-blue-600" id="score-value">0/10</p>
                    <p class="text-xl font-medium text-blue-500" id="score-percentage">0%</p>
                </div>
                <p id="score-feedback" class="text-lg font-semibold mb-8"></p>
                <div class="flex justify-center space-x-4">
                    <button id="try-again-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">View Dashboard</button>
                    <button id="logout-result-btn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Warning Modal -->
    <div id="warning-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm text-center transform scale-95 transition-transform duration-300">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 mb-4">
                <svg class="h-10 w-10 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Warning!</h3>
            <p id="warning-text" class="text-gray-600"></p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            //Add yours firebase components By creating account.
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "", // Corrected format
            messagingSenderId: "",
            appId: ""
        };
        // ***************************************************************

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- MOCK DATABASE (Questions) ---
        const questions = [
            { question: "Which of the following is not a valid C variable name?", options: ["int number;", "float rate;", "int variable_count;", "int $main;"], correct: 3 },
            { question: "What is the size of `int` in a 32-bit compiler in C?", options: ["2 bytes", "4 bytes", "8 bytes", "Depends on the system"], correct: 1 },
            { question: "Which keyword is used to prevent any changes in the variable within a C program?", options: ["immutable", "const", "static", "volatile"], correct: 1 },
            { question: "What will be the output of `printf(\"%d\", printf(\"hello\"));`?", options: ["hello5", "5hello", "hello", "Error"], correct: 0 },
            { question: "What does the `&` operator do?", options: ["Bitwise AND", "Address of", "Dereference", "Both Bitwise AND and Address of"], correct: 3 },
            { question: "Which function is used to read a single character from the console in C?", options: ["scanf()", "getchar()", "gets()", "read()"], correct: 1 },
            { question: "In C, what is the correct way to declare a pointer to an integer?", options: ["int ptr;", "int *ptr;", "ptr int;", "*int ptr;"], correct: 1 },
            { question: "What is the purpose of the `break` statement in C?", options: ["To exit from a loop or switch statement", "To skip the current iteration of a loop", "To end the program", "To return a value from a function"], correct: 0 },
            { question: "How do you define a macro in C?", options: ["#macro PI 3.14", "macro PI 3.14", "#define PI 3.14", "define PI 3.14"], correct: 2 },
            { question: "What is the output of `sizeof(char)` in a C program?", options: ["1", "2", "4", "Implementation defined"], correct: 0 }
        ];
        
        // --- DOM Elements ---
        const views = document.querySelectorAll('.view');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupLink = document.getElementById('show-signup');
        const showLoginLink = document.getElementById('show-login');
        const logoutBtn = document.getElementById('logout-btn');
        const logoutResultBtn = document.getElementById('logout-result-btn');
        const startTestBtn = document.getElementById('start-test-btn');
        const timerEl = document.getElementById('timer');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const questionNumberEl = document.getElementById('question-number');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const submitTestBtn = document.getElementById('submit-test-btn');
        const scoreValueEl = document.getElementById('score-value');
        const scorePercentageEl = document.getElementById('score-percentage');
        const scoreFeedbackEl = document.getElementById('score-feedback');
        const tryAgainBtn = document.getElementById('try-again-btn');
        const warningModal = document.getElementById('warning-modal');
        const warningText = document.getElementById('warning-text');
        const testView = document.getElementById('test-view');

        // --- Application State ---
        let currentUserData = null; // Will hold Firestore data
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let timerInterval;
        let timeLeft = 300;
        let cheatAttempts = 0;
        
        // --- Functions ---
        const showView = (viewId) => {
            views.forEach(view => view.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';
        };

        const showLoader = (button) => {
            button.innerHTML = `<div class="loader mx-auto"></div>`;
            button.disabled = true;
        };

        const hideLoader = (button, text) => {
            button.innerHTML = text;
            button.disabled = false;
        };

        // --- Auth State Change Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    currentUserData = userDocSnap.data();
                    showDashboard();
                } else {
                    console.error("No user data found in Firestore for authenticated user!");
                    handleLogout();
                }
            } else {
                // User is signed out
                currentUserData = null;
                showView('login-view');
            }
        });

        // --- Auth Functions ---
        const handleSignup = async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            showLoader(button);
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Create user document in Firestore
                await setDoc(doc(db, "users", user.uid), {
                    name: name,
                    email: email,
                    pastAttempts: []
                });
                
                signupForm.reset();
                // onAuthStateChanged will handle redirecting to dashboard
            } catch (error) {
                alert(`Signup failed: ${error.message}`);
            } finally {
                hideLoader(button, 'Sign Up');
            }
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button');
            showLoader(button);
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginForm.reset();
                // onAuthStateChanged will handle redirecting to dashboard
            } catch (error) {
                alert(`Login failed: ${error.message}`);
            } finally {
                hideLoader(button, 'Login');
            }
        };
        
        const handleLogout = async () => {
            await signOut(auth);
        };
        
        // --- App Logic ---
        const showDashboard = () => {
            document.getElementById('user-name').textContent = currentUserData.name;
            const attemptsList = document.getElementById('past-attempts-list');
            
            if (currentUserData.pastAttempts && currentUserData.pastAttempts.length > 0) {
                attemptsList.innerHTML = '';
                // Display latest attempts first
                const reversedAttempts = [...currentUserData.pastAttempts].reverse();
                reversedAttempts.forEach(attempt => {
                    const attemptEl = document.createElement('div');
                    attemptEl.className = 'flex justify-between items-center p-2 border-b';
                    const date = new Date(attempt.timestamp).toLocaleString();
                    attemptEl.innerHTML = `
                        <span>Score: <strong>${attempt.score}/${questions.length}</strong></span>
                        <span class="text-sm text-gray-500">${date}</span>
                    `;
                    attemptsList.appendChild(attemptEl);
                });
            } else {
                attemptsList.innerHTML = '<p class="text-gray-500">You have no previous attempts.</p>';
            }
            
            showView('instructions-view');
        };

        // --- Timer Functions --- [FIXED]
        const startTimer = () => {
            timerInterval = setInterval(updateTimer, 1000);
        };

        const updateTimer = () => {
            const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const seconds = (timeLeft % 60).toString().padStart(2, '0');
            timerEl.textContent = `${minutes}:${seconds}`;

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitTest();
            }
            timeLeft--;
        };

        const startTest = () => {
            cheatAttempts = 0;
            userAnswers = new Array(questions.length).fill(null);
            currentQuestionIndex = 0;
            timeLeft = 300;
            
            document.documentElement.requestFullscreen().catch(err => {
                alert(`Error attempting to enable full-screen mode: ${err.message}`);
            });
            
            setupProctoring();
            loadQuestion();
            startTimer(); // This function will now work correctly
            showView('test-view');
        };

        const loadQuestion = () => {
            const question = questions[currentQuestionIndex];
            questionTextEl.textContent = question.question;
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionId = `option-${index}`;
                optionsContainer.innerHTML += `
                    <div>
                        <input type="radio" name="option" value="${index}" id="${optionId}" class="hidden">
                        <label for="${optionId}" class="block cursor-pointer p-4 border rounded-lg hover:bg-gray-100 transition duration-200">${option}</label>
                    </div>`;
            });

            if (userAnswers[currentQuestionIndex] !== null) {
                document.querySelector(`input[name="option"][value="${userAnswers[currentQuestionIndex]}"]`).checked = true;
            }
            
            questionNumberEl.textContent = currentQuestionIndex + 1;
            nextQuestionBtn.classList.toggle('hidden', currentQuestionIndex === questions.length - 1);
            submitTestBtn.classList.toggle('hidden', currentQuestionIndex !== questions.length - 1);
        };
        
        const handleNextQuestion = () => {
            const selectedOption = document.querySelector('input[name="option"]:checked');
            userAnswers[currentQuestionIndex] = selectedOption ? parseInt(selectedOption.value) : null;
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            }
        };

        const submitTest = async () => {
            clearInterval(timerInterval);
            
            const selectedOption = document.querySelector('input[name="option"]:checked');
            userAnswers[currentQuestionIndex] = selectedOption ? parseInt(selectedOption.value) : null;

            let score = 0;
            userAnswers.forEach((answer, index) => {
                if (answer === questions[index].correct) {
                    score++;
                }
            });

            // Save result to Firestore
            const user = auth.currentUser;
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const newAttempt = {
                    score: score,
                    timestamp: Date.now()
                };
                await updateDoc(userDocRef, {
                    pastAttempts: arrayUnion(newAttempt)
                });
            }

            cleanupProctoring();
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            displayResults(score);
        };
        
        const displayResults = (score) => {
            const totalQuestions = questions.length;
            const percentage = Math.round((score / totalQuestions) * 100);
            
            scoreValueEl.textContent = `${score}/${totalQuestions}`;
            scorePercentageEl.textContent = `${percentage}%`;

            let feedback = '';
            if (percentage >= 80) {
                feedback = "Excellent Work!";
            } else if (percentage >= 60) {
                feedback = "Good Job!";
            } else if (percentage >= 40) {
                feedback = "You can do better.";
            } else {
                feedback = "Needs Improvement. Keep trying!";
            }
            scoreFeedbackEl.textContent = feedback;
            
            showView('result-view');
        };

        // Proctoring Functions
        const showWarning = (message) => {
            warningText.textContent = message;
            warningModal.classList.remove('opacity-0', 'pointer-events-none');
            warningModal.querySelector('div').classList.remove('scale-95');
            setTimeout(() => {
                warningModal.classList.add('opacity-0', 'pointer-events-none');
                warningModal.querySelector('div').classList.add('scale-95');
            }, 3000);
        };
        const handleVisibilityChange = () => { if (document.hidden && testView.style.display === 'block') { cheatAttempts++; showWarning(`You have switched tabs. Attempt ${cheatAttempts} logged.`); } };
        const handleFullscreenChange = () => { if (!document.fullscreenElement && testView.style.display === 'block') { setTimeout(() => { if (!document.fullscreenElement) { showWarning('Exited full-screen. Test auto-submitted.'); submitTest(); } }, 500); } };
        const disableEvent = (e) => { e.preventDefault(); showWarning("This action is disabled during the test."); };
        const setupProctoring = () => {
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            ['copy', 'paste', 'contextmenu'].forEach(event => document.addEventListener(event, disableEvent));
        };
        const cleanupProctoring = () => {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            document.removeEventListener('fullscreenchange', handleFullscreenChange);
            ['copy', 'paste', 'contextmenu'].forEach(event => document.removeEventListener(event, disableEvent));
        };
        
        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        signupForm.addEventListener('submit', handleSignup);
        showSignupLink.addEventListener('click', (e) => { e.preventDefault(); showView('signup-view'); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showView('login-view'); });
        logoutBtn.addEventListener('click', handleLogout);
        logoutResultBtn.addEventListener('click', handleLogout);
        startTestBtn.addEventListener('click', startTest);
        nextQuestionBtn.addEventListener('click', handleNextQuestion);
        submitTestBtn.addEventListener('click', submitTest);
        tryAgainBtn.addEventListener('click', showDashboard);

        // --- Initializer ---
        showView('loading-view');
        
    </script>
</body>
</html>
